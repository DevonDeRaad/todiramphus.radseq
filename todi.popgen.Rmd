---
title: "Todiramphus popgen"
author: "Devon DeRaad"
date: '2022-06-25'
output: html_document
---

# Start by reading in files and loading libraries
```{r}
library(vcfR)
library(StAMPP)
library(adegenet)
library(ggplot2)
library(RColorBrewer)
#read sample metadata
samps<-read.csv("~/Desktop/todi.2022/todiramphus.subset.csv")

#read in filtered vcf
vcf<-read.vcfR("~/Desktop/todi.2022/todi.85.vcf")

#keep sample metadata for only the samples that are retained in the vcf
samps<-samps[samps$id %in% colnames(vcf@gt),]
#write.csv(samps, "~/Desktop/todi.2022/todi.retained.samples.csv", quote = F, row.names = F)

#reorder sampling file to match order of samples in vcf
samps<-samps[match(colnames(vcf@gt)[-1], samps$id),]
#make sure order matches
samps$id == colnames(vcf@gt)[-1]
```

# make splitstree
```{r}
#convert each to genlight
gen<-vcfR2genlight(vcf)

#output pairwise difference matrix for each to run splitstree
gen@ind.names<-gsub(gen@ind.names, pattern = "T_", replacement = "")
gen@ind.names<-gsub(gen@ind.names, pattern = "_", replacement = "")
gen@ind.names<-gsub(gen@ind.names, pattern = "albicilla", replacement = "alb")
gen@ind.names<-gsub(gen@ind.names, pattern = "chloris", replacement = "chlor")
gen@ind.names<-gsub(gen@ind.names, pattern = "colonus", replacement = "col")
gen@ind.names<-gsub(gen@ind.names, pattern = "sanctus", replacement = "san")
gen@ind.names<-gsub(gen@ind.names, pattern = "saurophagus", replacement = "saur")
gen@ind.names<-gsub(gen@ind.names, pattern = "sordidus", replacement = "sord")
gen@ind.names<-gsub(gen@ind.names, pattern = "tristrami", replacement = "tris")
gen@ind.names<-gsub(gen@ind.names, pattern = "leucopygius", replacement = "leu")
gen@ind.names<-gsub(gen@ind.names, pattern = "DOT", replacement = "D")
gen@ind.names

#assign pops
gen@pop<-as.factor(samps$species)
#generate pairwise divergence matrix
sample.div <- stamppNeisD(gen, pop = FALSE)
#export for splitstree
#stamppPhylip(distance.mat=sample.div, file="~/Desktop/todi.2022/todi.85.splits.txt")

#visualize 85% completeness cutoff splitstree
knitr::include_graphics(c("/Users/devder/Desktop/todi.2022/todi.85.splitstree.png"))
```

# now we will do clustering
```{r}
#start by generating a vcf with no missing data for input to popvae
#we are doing this because the VAE does not seem to handle missing data well and clusters samples strangely in the presence of missing data
#generate 0 missing data vcf
library(SNPfiltR)
v<-missing_by_snp(vcf, cutoff = 0)
#write this to disk
#vcfR::write.vcf(v, file="~/Desktop/todi.2022/popvae/todi.100.vcf.gz")
```

# run 5 popvae iterations on the no missing data vcf, using this bash chunk
```{bash, eval = FALSE}
#make sure R can find my conda installation
source ~/.bash_profile
#module load popvae
conda activate popvae
#run the following code in order to execute popVAE from the command line 10 times
for i in {1..5}; do mkdir /Users/devder/Desktop/todi.2022/popvae/out.${i}; popvae.py --infile /Users/devder/Desktop/todi.2022/popvae/todi.100.vcf.gz --out /Users/devder/Desktop/todi.2022/popvae/out.${i}/todi.rad --seed 50; done
```

# now come back to R and plot each of the 5 clustering schemes generated by popVAE
```{r}
#bring in latent space coordinates from 5 popVAE runs and do clustering analysis here:
popvae<-list()
for (i in 1:5){
  popvae[[i]]<-read.table(paste0("/Users/devder/Desktop/todi.2022/popvae/out.",{i},"/todi.rad_latent_coords.txt"), header = T)
}
#check that the order output by popvae matches the order of our existing sampling data frame
samps$id == popvae[[i]]$sampleID

for (i in 1:5){
  plot.df<-data.frame(species=samps$species,
                      LD1=popvae[[i]]$mean1,
                      LD2=popvae[[i]]$mean2)
  print(ggplot(data=plot.df, aes(x=LD1, y=LD2, col=species))+
    geom_point(cex=3)+
    scale_color_manual(values=brewer.pal(8, "Set2"))+
    theme_classic()+
    labs(x="LD 1",y="LD 2"))
}

#I will pick a repesentative iteration
plot.df$LD1<-popvae[[3]]$mean1
plot.df$LD2<-popvae[[3]]$mean2

## plot representative vae iteration
ggplot(data=plot.df, aes(x=LD1, y=LD2, col=species))+
  geom_point(cex=3)+
  theme_classic()+
  scale_color_manual(values=brewer.pal(8, "Set2"))+
  labs(x="LD 1",y="LD 2")+
  theme(legend.text = element_text(face = "italic"))

#save plot
vae.plot<-ggplot(data=plot.df, aes(x=LD1, y=LD2, col=species))+
  geom_point(cex=3)+
  theme_classic()+
  scale_color_manual(values=brewer.pal(8, "Set2"))+
  labs(x="LD 1",y="LD 2")+
  theme(legend.text = element_text(face = "italic"))

#write plot to disk as PDF
#ggsave("~/Desktop/todi.2022/vae.plot.pdf", vae.plot, width = 5,height = 2.75,units = "in")
```

# make heterozygostiy/pi dot chart
```{r}
#run this in bash, where retained.popmap.txt assigns samples to species, to get species level pi estimates
#and todi.singlesample.popmap.txt assigns each sample as a unique population to get per individual heterozygosity estimates
# Run populations and export population info
#/home/d669d153/work/stacks-2.41/populations -P ./fastq -M retained.popmap.txt --fstats -O /home/d669d153/work/todi.subset.2022/fixed.pops
# Run populations and export population info
#/home/d669d153/work/stacks-2.41/populations -P ./fastq -M todi.singlesample.popmap.txt -O /home/d669d153/work/todi.subset.2022/singlesample


#read in each output file
#pops
pi.pops<-read.table("~/Desktop/todi.2022/pi.het.info/fixed.pops/populations.sumstats_summary.tsv", header=T, sep='\t')
#per sample
pi.sample<-read.table("~/Desktop/todi.2022/pi.het.info/singlesample/populations.sumstats_summary.tsv", header=T, sep='\t')

plotting.df<-data.frame(sample=pi.sample$Pop.ID,
                        species=as.factor(gsub("_.*","",gsub("T_","",pi.sample$Pop.ID))),
                        het=pi.sample$Obs_Het,
                        pi=c(rep(.00025, times=6),rep(.00089, times=11),rep(.0008, times=3),rep(.00109, times=30),
                             rep(.00034, times=6),rep(.00078, times=8),rep(.00074, times=14),rep(.00082, times=5)),
                        col=c(rep(brewer.pal(8, "Set2")[1],times=6),rep(brewer.pal(8,"Set2")[2], times=11),
                              rep(brewer.pal(8, "Set2")[3], times=3),rep(brewer.pal(8, "Set2")[4], times=30),
                             rep(brewer.pal(8, "Set2")[5], times=6),rep(brewer.pal(8, "Set2")[6], times=8),
                             rep(brewer.pal(8, "Set2")[7], times=14),rep(brewer.pal(8, "Set2")[8], times=5))
)
#fix samples that were originally mislabeled
plotting.df$species[74:78]<-rep("sanctus", times=5)
plotting.df$col[74:78]<-rep(brewer.pal(8, "Set2")[4], times=5)

pi.pops$species<-pi.pops$Pop.ID
#plot heterozygosity violin plots
ggplot(plotting.df, aes(x=species, y=het)) + 
  #geom_violin(trim = FALSE)+
  geom_dotplot(binaxis='y', stackdir='center', dotsize = 1, alpha=.75, aes(fill=col,color=col))+
  theme_classic()+
  scale_fill_manual(values=brewer.pal(8, "Set2")[c(1,3,6,4,8,5,2,7)])+
  scale_color_manual(values=brewer.pal(8, "Set2")[c(1,3,6,4,8,5,2,7)])+
  #scale_x_discrete(labels=c("California","Florida","Island","Sumichrast","Texas","Woodhouse"))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size=12, face = "italic", color="black"),
        axis.text.y = element_text(angle = 45, hjust = 1, size = 12),
        legend.position = "none")+
  geom_point(pi.pops, mapping=aes(y=Pi), pch=8, cex=3)+
  labs(x="",y="heterozygosity")+
  scale_y_continuous(sec.axis = sec_axis(trans = (~.*1), name="Pi"))

#save plot
het.plot<-ggplot(plotting.df, aes(x=species, y=het)) + 
  #geom_violin(trim = FALSE)+
  geom_dotplot(binaxis='y', stackdir='center', dotsize = 1, alpha=.75, aes(fill=col,color=col))+
  theme_classic()+
  scale_fill_manual(values=brewer.pal(8, "Set2")[c(1,3,6,4,8,5,2,7)])+
  scale_color_manual(values=brewer.pal(8, "Set2")[c(1,3,6,4,8,5,2,7)])+
  #scale_x_discrete(labels=c("California","Florida","Island","Sumichrast","Texas","Woodhouse"))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size=12, face = "italic", color="black"),
        axis.text.y = element_text(angle = 45, hjust = 1, size = 12),
        legend.position = "none")+
  geom_point(pi.pops, mapping=aes(y=Pi), pch=8, cex=3)+
  labs(x="",y="heterozygosity")+
  scale_y_continuous(sec.axis = sec_axis(trans = (~.*1), name="Pi"))

#save plot
ggsave("~/Desktop/todi.2022/het.pi.plot.pdf", het.plot,
       width = 5,height = 4.5,units = "in")

```

